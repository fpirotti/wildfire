---
title: "Untitled"
author: "CIRGEO - Francesco Pirotti"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
classoption: landscape
---

```{r echo=FALSE, message=FALSE, warning=FALSE,results='asis'}

library(knitr) 

library(kableExtra)
library(terra)
library(Metrics)
library(gt)
library(tidyverse)
library(yardstick)

todos <- list(
CZ_AT = list(  pred = terra::rast("input/CZ-AT_ScottBurganFuelMapClassV2.tif") ,
                obs = terra::rast("data/validation/WildfireCE_Fuel_map_validation_AT-CZ_CzechGlobe_model.tif") 
            ),

DE_CZ = list(pred = terra::rast("input/DE-CZ_ScottBurganFuelMapClassV2.tif"),
               obs = terra::rast("data/validation/WildfireCE_Fuel_map_validation_DE-CZ_CzechGlobe_model.tif")
 )
)

risultati <- list()
for(area in names(todos) ){
  pred <- todos[[area]][["pred"]]
  ref <- todos[[area]][["obs"]]
  cls<-terra::resample( terra::project(pred, ref, method="near"), ref, method="near" )

  cls[cls==0] <- NA
  ref[ref==0] <- NA
  
  s <- c(ref, cls)
  
    # terra::writeRaster(s,
    #                  sprintf("input/%s_ScottBurganFuelMapClassV2_32633.tif",
    #                          area), overwrite=T )
    
  # plot(s)
  # Extract values as a data.frame
  vals <- na.omit(as.data.frame(s, xy=FALSE))
  colnames(vals) <- c("CzechGlobe", "WildFire")
  
  lvs <- sort(unique(c(vals$WildFire, vals$CzechGlobe)))
  
  vals$WildFire <- factor(vals$WildFire, levels = lvs)
  vals$CzechGlobe <-  factor(vals$CzechGlobe, levels = lvs) 
  
  conf_mat <- table(vals$CzechGlobe, vals$WildFire)
  # Overall accuracy
  overall_acc <- sum(diag(conf_mat)) / sum(conf_mat) 
  # Producer's accuracy (per class)
  prod_acc <- diag(conf_mat) / rowSums(conf_mat) 
  # User's accuracy (per class)
  user_acc <- diag(conf_mat) / colSums(conf_mat) 
  # Kappa
  pe <- sum(rowSums(conf_mat) * colSums(conf_mat)) / (sum(conf_mat)^2)
  kappa <- (overall_acc - pe) / (1 - pe)
  
  vals$CzechGlobe2 <-  trunc(as.integer(as.character(vals$CzechGlobe))/10) 
  vals$WildFire2 <- trunc(as.integer(as.character(vals$WildFire))/10)  
  lvs <- sort(unique(c(vals$WildFire2, vals$CzechGlobe2)))
  
  vals$WildFire2 <- factor(vals$WildFire2, levels = lvs)
  vals$CzechGlobe2 <-  factor(vals$CzechGlobe2, levels = lvs) 
  
  conf_mat2 <- table(Reference = vals$CzechGlobe2, Classified=vals$WildFire2)
  # Overall accuracy
  overall_acc2 <- sum(diag(conf_mat2)) / sum(conf_mat2) 
  # Producer's accuracy (per class)
  prod_acc2 <- diag(conf_mat2) / rowSums(conf_mat2) 
  # User's accuracy (per class)
  user_acc2 <- diag(conf_mat2) / colSums(conf_mat2) 
  # Kappa
  pe2 <- sum(rowSums(conf_mat2) * colSums(conf_mat2)) / (sum(conf_mat2)^2)
  kappa2 <- (overall_acc2 - pe2) / (1 - pe2)

  cm_ext <-  as.matrix(conf_mat2)
  cm_ext <- cbind(cm_ext, "Prod.Acc" = sprintf("%.1f%%", prod_acc2*100)) 
  # Add Userâ€™s Accuracy as extra row
  cm_ext <- rbind(cm_ext, "User.Acc" = c(sprintf("%.1f%%", user_acc2*100), 
                                         sprintf("%.1f%%", overall_acc2*100)))

  
k <- kable(cm_ext, align = "r", caption = paste0("Confusion Matrix rows=CzechGlobe (reference)   colums=Wildfire (Classified)   kappa=", round(kappa2,3)) ) %>%
  kable_styling(full_width = FALSE, latex_options = c("hold_position", "striped", "scale_down")) %>%
  column_spec(1, bold = TRUE) 


print(k)
  
}
  
```

